<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Autenticación con Node.js - midudev</title>
  <style>
    /* Estilos básicos que midudev suele aplicar */
    body { font-family: system-ui, -apple-system, sans-serif; display: grid; place-content: center; min-height: 100vh; background: #111; color: #fff; }
    form { display: flex; flex-direction: column; gap: 8px; border: 1px solid #333; padding: 16px; border-radius: 8px; margin-bottom: 20px; }
    input { padding: 8px; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff; }
    button { padding: 8px; border-radius: 4px; border: none; background: #0070f3; color: #fff; cursor: pointer; }
    button:hover { background: #0051bb; }
    .logout-btn { background: #ff4444; }
  </style>
</head>
<body>

  <% if (username) { %>
    <h1>Hola <%= username %>!</h1>
    <p>Has iniciado sesión correctamente.</p>
    <button class="logout-btn" id="logout">Cerrar sesión</button>
  <% } else { %>
    <h1>Inicia sesión o regístrate</h1>
    
    <section>
      <h2>Login</h2>
      <form id="login-form">
        <input type="text" name="username" placeholder="Username" required>
        <input type="password" name="password" placeholder="Password" required>
        <button type="submit">Entrar</button>
      </form>

      <h2>Registro</h2>
      <form id="register-form">
        <input type="text" name="username" placeholder="Username" required>
        <input type="password" name="password" placeholder="Password" required>
        <button type="submit">Crear cuenta</button>
      </form>
    </section>
  <% } %>

  <script>
    // Lógica para el Login
    const loginForm = document.querySelector('#login-form')
    if (loginForm) {
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault()
        const { username, password } = Object.fromEntries(new FormData(e.target))
        
        const res = await fetch('/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        })

        if (res.ok) {
          window.location.reload() // Recarga para que EJS detecte la nueva cookie
        } else {
          const error = await res.json()
          alert(error.message || 'Error al iniciar sesión')
        }
      })
    }

    // Lógica para el Registro
    const registerForm = document.querySelector('#register-form')
    if (registerForm) {
      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault()
        const { username, password } = Object.fromEntries(new FormData(e.target))
        
        const res = await fetch('/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        })

        if (res.ok) {
          alert('Usuario creado correctamente, ahora inicia sesión')
        } else {
          const error = await res.json()
          alert(error.message || 'Error al registrar')
        }
      })
    }

    // Lógica para el Logout
    const logoutBtn = document.querySelector('#logout')
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        await fetch('/logout', { method: 'POST' })
        window.location.reload()
      })
    }
  </script>
</body>
</html>